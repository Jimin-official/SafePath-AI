{% extends "base.html" %}

{% block title %}ë§ˆì´í˜ì´ì§€{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .mypage-container {
      max-width: 1200px; /* ìµœëŒ€ ë„ˆë¹„ë¥¼ ì‚´ì§ ë„“í˜€ ì¾Œì í•˜ê²Œ */
      margin: 2rem auto;
      padding: 2rem;
      font-family: "Pretendard", "Noto Sans KR", sans-serif; /* Pretendard í°íŠ¸ ìš°ì„  ì ìš© (ì—†ìœ¼ë©´ Noto Sans KR) */
      background-color: #f8f9fa; /* í˜ì´ì§€ ì „ì²´ì— ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
    }
    /* --- ì „ì²´ ì¹´ë“œ ë ˆì´ì•„ì›ƒ --- */
    .mypage-card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #e9ecef;
    }
    .mypage-card h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .mypage-card h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #343a40;
    }
    
    .tabs {
      display: flex;
      border-bottom: 2px solid #dee2e6;
      margin-bottom: 2rem; /* íƒ­ê³¼ ì½˜í…ì¸  ì‚¬ì´ ê°„ê²© ì¶”ê°€ */
    }
    .tab-link {
      padding: 0.8rem 1.2rem;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1rem;
      font-weight: 500;
      color: #868e96;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease-in-out;
    }
    .tab-link:hover {
        color: #007bff;
    }
    .tab-link.active {
      border-bottom: 3px solid #007bff;
      font-weight: 700;
      color: #343a40;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* --- ê¸°ë¡ í…Œì´ë¸”(Table) ìŠ¤íƒ€ì¼ --- */
    .history-layout { display: flex; gap: 1.5rem; }
    .history-table-wrapper { flex: 2; max-height: 80vh; overflow-y: auto; }
    #historyMap { flex: 3; height: 80vh; border-radius: 8px; border: 1px solid #dee2e6; }
    
    /* ì§€ë„(Map) ë„ˆë¹„ ë¹„ìœ¨ì„ ëŠ˜ë¦½ë‹ˆë‹¤. */
    #historyMap { 
        flex: 3; /* 2 -> 3ìœ¼ë¡œ ë³€ê²½ (ë„ˆë¹„ ëŠ˜ë¦¼) */
        height: 80vh; /* 70vh -> 80vhë¡œ ë³€ê²½ (ë†’ì´ ëŠ˜ë¦¼) */
        border-radius: 8px; 
        border: 1px solid #ccc; 
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .history-table th, .history-table td {
      padding: 0.9rem 0.7rem;
      border-bottom: 1px solid #e9ecef; /* í•˜ë‹¨ í…Œë‘ë¦¬ë§Œ ì‚¬ìš© */
      text-align: center;
      vertical-align: middle;
    }

    .history-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }
    .history-table tbody tr:hover {
      background-color: #f1f7ff; /* í˜¸ë²„ ì‹œ ì—°í•œ íŒŒë€ìƒ‰ */
    }
    
    /* ì•Œê³ ë¦¬ì¦˜ë³„ ê²½ë¡œ í‘œì‹œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .path-btn {
        background: none; border: none; padding: 0;
        cursor: pointer; text-decoration: underline; font: inherit;
        transition: color 0.2s ease;
    }
    .path-btn:hover { text-decoration: none; }
    .path-btn.dlite { color: #dc3545; } /* red */
    .path-btn.cch_a { color: #007bff; } /* blue */
    .path-btn.rtaa { color: #28a745; } /* green */
    .path-btn:disabled { color: #adb5bd; text-decoration: none; cursor: not-allowed; }
    
    /* --- ë‚´ ì •ë³´ í¼(Form) ìŠ¤íƒ€ì¼ --- */
    .info-form .form-group { margin-bottom: 1.5rem; }
    .info-form label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #495057; }
    .info-form input {
      width: 100%;
      max-width: 400px;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 8px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    
    .info-form input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    /* --- ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
    .btn-submit {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      background-color: #007bff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .btn-submit:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
    }
    #deleteHistoryBtn {
        background-color: #dc3545; /* ì‚­ì œ ë²„íŠ¼ì€ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ */
    }
    #deleteHistoryBtn:hover {
        background-color: #c82333;
    }
    /* --- í†µê³„ ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ --- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    .stat-card, .chart-container {
      background-color: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    .stat-card h3, .chart-container h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1rem;
      font-weight: 600;
      color: #495057;
    }
    .stat-card p {
      font-size: 2rem;
      font-weight: 700;
      color: #007bff;
      margin: 0;
    }
    .chart-container canvas {
        max-width: 100%;
    }

  </style>
{% endblock %}

{% block content %}
<div class="mypage-container">
  <div class="mypage-card"> 
    <h1>ë§ˆì´í˜ì´ì§€</h1>
  
    <div class="tabs">
      <button class="tab-link active" onclick="openTab(event, 'history')">ğŸ“ ì„œë¹„ìŠ¤ ì‚¬ìš© ê¸°ë¡</button>
      <button class="tab-link" onclick="openTab(event, 'stats')">ğŸ“Š í†µê³„</button>
      <button class="tab-link" onclick="openTab(event, 'my-info')">ğŸ™‹ğŸ»â€â™‚ï¸ ë‚´ ì •ë³´</button>
    </div>
    <!-- <div style="margin-bottom: 1rem; text-align: right;">
      <button id="deleteHistoryBtn" class="btn-submit" style="background-color: #dc3545;">ì„ íƒ ê¸°ë¡ ì‚­ì œ</button>
    </div> -->
    <!-- 1. ì„œë¹„ìŠ¤ ì‚¬ìš© ê¸°ë¡ íƒ­ -->
    <div id="history" class="tab-content active">
  
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>ê²½ë¡œ íƒìƒ‰ ê¸°ë¡</h2>
        <button id="deleteHistoryBtn" class="btn-submit" style="background-color: #dc3545;">ì„ íƒ ê¸°ë¡ ì‚­ì œ</button>
      </div>

      <form action="{{ url_for('mypage') }}" method="get" class="search-form">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem;">
          <input type="text" name="q" placeholder="ì¶œë°œì§€ ë˜ëŠ” ë„ì°©ì§€ ê²€ìƒ‰" value="{{ search_values.q or '' }}" 
                style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
          
          <label for="start-date" style="font-size: 14px;">ê¸°ê°„:</label>
          <input type="date" id="start-date" name="start_date" value="{{ search_values.start_date or '' }}"
                style="padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
          <span>~</span>
          <input type="date" id="end-date" name="end_date" value="{{ search_values.end_date or '' }}"
                style="padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
          
          <button type="submit" class="btn-submit" style="padding: 8px 16px;">ê²€ìƒ‰</button>
          <a href="{{ url_for('mypage') }}" style="padding: 8px 16px; color: #6c757d; text-decoration: none;">ì´ˆê¸°í™”</a>
        </div>
      </form>
      <div class="history-layout">
        <div class="history-table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllCheckbox"></th>
                <th>ê²€ìƒ‰ ê¸°ë¡</th>
                <th>ê²€ìƒ‰ì¼ì‹œ</th>
                <th>ì¶œë°œì§€</th>
                <th>ë„ì°©ì§€</th>
                <th>D* Lite</th>
                <th>CCH + A*</th>
                <th>RTAA*</th>
              </tr>
            </thead>
            <tbody>
              {% for record in history %}
              <tr>
                <td>
                    <input type="checkbox" class="history-checkbox" data-request-id="{{ record.request_id }}">
                </td>
                <td>{{ user_info.user_id }}-{{ loop.revindex }}</td>
                <td>{{ record.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ record.start_address }}</td>
                <td>{{ record.goal_address }}</td>
                
                <td>
                  <button class="path-btn dlite" 
                          data-path='{{ record.paths_by_algo.dlite | default(none) | tojson | e }}'
                          {% if not record.paths_by_algo.dlite %}disabled{% endif %}>
                    ê²½ë¡œ ë³´ê¸°
                  </button>
                </td>
                <td>
                  <button class="path-btn cch_a" 
                          data-path='{{ record.paths_by_algo.cch_a | default(none) | tojson | e }}'
                          {% if not record.paths_by_algo.cch_a %}disabled{% endif %}>
                    ê²½ë¡œ ë³´ê¸°
                  </button>
                </td>
                <td>
                  <button class="path-btn rtaa"
                          data-path='{{ record.paths_by_algo.rtaa | default(none) | tojson | e }}'
                          {% if not record.paths_by_algo.rtaa %}disabled{% endif %}>
                    ê²½ë¡œ ë³´ê¸°
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="historyMap"></div>
      </div>
    </div>
    <!-- 2. í†µê³„ íƒ­ -->
    <div id="stats" class="tab-content">
      <h2>í™œë™ í†µê³„</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>ì´ ì´ë™ ê±°ë¦¬</h3>
          <p id="totalDistanceStat">- km</p>
        </div>
        <div class="stat-card">
          <h3>ì´ íƒìƒ‰ íšŸìˆ˜</h3>
          <p id="totalSearchesStat">- íšŒ</p>
        </div>
      </div>
      <div class="stats-grid">
        <div class="chart-container" style="height:400px;">
          <h3>ì•Œê³ ë¦¬ì¦˜ë³„ ì´ ì´ë™ê±°ë¦¬ (km)</h3>
          <canvas id="algoDistanceChart"></canvas>
        </div>
        <div class="chart-container" style="height:400px;">
          <h3>ì›”ë³„ íƒìƒ‰ í™œë™ (ìµœê·¼ 6ê°œì›”)</h3>
          <canvas id="monthlyActivityChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 3. ë‚´ ì •ë³´ íƒ­ -->
    <div id="my-info" class="tab-content">
      <h2>ê³„ì • ì •ë³´ ìˆ˜ì •</h2>
      <form id="infoForm" class="info-form">
        <div class="form-group">
          <label for="userId">ì•„ì´ë””</label>
          <input type="text" id="userId" name="user_id" value="{{ user_info.user_id }}">
        </div>
        <div class="form-group">
          <label for="address">ì£¼ì†Œ</label>
          <input type="text" id="address" name="address" value="{{ user_info.address }}">
        </div>

        <div class="form-group">
          <label for="email">ì´ë©”ì¼</label>
          <input type="email" id="email" name="email" value="{{ user_info.email }}">
        </div>
        <div class="form-group">
          <label for="phone">ì „í™”ë²ˆí˜¸</label>
          <input type="tel" id="phone" name="phone" value="{{ user_info.phone }}">
        </div>
        <button type="submit" class="btn-submit">ì •ë³´ ì €ì¥</button>
      </form>
      <div style="margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6;">
        <h3 style="font-size: 1.1rem; color: #dc3545;">íšŒì› íƒˆí‡´</h3>
        <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 1rem;">
          ê³„ì •ì„ íƒˆí‡´í•˜ë©´ ëª¨ë“  ê²½ë¡œ ê¸°ë¡ê³¼ ì¦ê²¨ì°¾ê¸° ì •ë³´ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©°, ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <button id="deleteAccountBtn" class="btn-submit" style="background-color: #dc3545;">
          íšŒì› íƒˆí‡´ ì§„í–‰
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let algoChart = null;
  let monthlyChart = null;
  
  // íƒ­ ê¸°ëŠ¥
  function openTab(evt, tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
    document.getElementById(tabName).style.display = 'block';
    evt.currentTarget.classList.add('active');

    // í†µê³„ íƒ­ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ì°¨íŠ¸ ë¡œë“œ
    if (tabName === 'stats') {
      loadAndRenderStats();
    }
  }
  // í†µê³„ ë°ì´í„° ë¡œë“œ ë° ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜
  async function loadAndRenderStats() {
    try {
      const response = await fetch('/get_user_stats');
      const data = await response.json();

      if (!data.success) {
        alert(data.message);
        return;
      }

      const stats = data.stats;

      // 1. í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
      document.getElementById('totalDistanceStat').textContent = `${stats.total_distance_km} km`;
      document.getElementById('totalSearchesStat').textContent = `${stats.total_searches} íšŒ`;

      // 2. ì•Œê³ ë¦¬ì¦˜ë³„ ì´ë™ê±°ë¦¬ (íŒŒì´ ì°¨íŠ¸)
      const algoCtx = document.getElementById('algoDistanceChart').getContext('2d');
      const algoData = {
        labels: Object.keys(stats.algorithm_distance),
        datasets: [{
          label: 'ì´ë™ ê±°ë¦¬ (km)',
          data: Object.values(stats.algorithm_distance),
          backgroundColor: ['#dc3545', '#007bff', '#28a745', '#ffc107', '#17a2b8'],
        }]
      };
      // â–¼â–¼â–¼ ì¤‘ìš”: ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒê´´í•˜ê³  ìƒˆë¡œ ìƒì„± (yì¶• ê¸¸ì–´ì§ ë¬¸ì œ í•´ê²°) â–¼â–¼â–¼
      if (algoChart) algoChart.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
      algoChart = new Chart(algoCtx, {
        type: 'pie',
        data: algoData,
        options: { responsive: true, maintainAspectRatio: false }
      });

      // 3. ì›”ë³„ íƒìƒ‰ í™œë™ (ë§‰ëŒ€ ì°¨íŠ¸)
      const monthlyCtx = document.getElementById('monthlyActivityChart').getContext('2d');
      const monthlyLabels = [];
      const monthlyDataPoints = [];
      const today = new Date();
      for (let i = 5; i >= 0; i--) {
        const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        monthlyLabels.push(monthKey);
        monthlyDataPoints.push(stats.monthly_activity[monthKey] || 0);
      }
      const monthlyData = {
        labels: monthlyLabels,
        datasets: [{
          label: 'íƒìƒ‰ íšŸìˆ˜',
          data: monthlyDataPoints,
          backgroundColor: 'rgba(0, 123, 255, 0.6)',
          borderColor: 'rgba(0, 123, 255, 1)',
          borderWidth: 1
        }]
      };
      if (monthlyChart) monthlyChart.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
      monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: monthlyData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });

    } catch (error) {
      console.error("í†µê³„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
      alert("í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // ë‚´ ì •ë³´ ìˆ˜ì • í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  const infoForm = document.getElementById('infoForm');
  if(infoForm){
    infoForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      fetch('/update_user_info', { method: 'POST', body: formData })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        if (data.success) {
          location.reload();
        }
      })
      .catch(error => console.error('Error:', error));
    });
  }

  // ì„œë¹„ìŠ¤ ì‚¬ìš© ê¸°ë¡ ì§€ë„ ê¸°ëŠ¥ (DOMContentLoaded ì‚¬ìš©)
  document.addEventListener('DOMContentLoaded', function() {
    const mapElement = document.getElementById('historyMap');
    if (!mapElement) return; // ì§€ë„ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨

    const map = L.map('historyMap').setView([37.5665, 126.9780], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let currentPathLayer = null;

    document.querySelectorAll('.path-btn').forEach(button => {
      button.addEventListener('click', function() {
        if (currentPathLayer) map.removeLayer(currentPathLayer);

        const pathJson = this.dataset.path;
        
        // ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ 'None' ë¬¸ìì—´ì´ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
        if (!pathJson || pathJson === 'None' || pathJson.trim() === '') {
          console.log("ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        try {
          const pathCoords = JSON.parse(pathJson); 
          if (pathCoords && pathCoords.length > 0) {
            const color = this.classList.contains('dlite') ? 'red' :
                          this.classList.contains('cch_a') ? 'blue' : 'green';
            
            currentPathLayer = L.polyline(pathCoords, { color: color }).addTo(map);
            map.fitBounds(currentPathLayer.getBounds());
          }
        } catch (err) {
          console.error("ê²½ë¡œ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:", err, "ì›ë³¸ ë°ì´í„°:", pathJson);
          alert("ê²½ë¡œ ë°ì´í„°ë¥¼ ì§€ë„ì— í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°œë°œì ì½˜ì†”(F12)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
      });
    });
    const deleteBtn = document.getElementById('deleteHistoryBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const rowCheckboxes = document.querySelectorAll('.history-checkbox');
    // --- íšŒì› íƒˆí‡´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', function() {
            
            // 1ì°¨ í™•ì¸
            if (!confirm("ì •ë§ë¡œ íšŒì› íƒˆí‡´ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                return;
            }

            // 2ì°¨ ìµœì¢… í™•ì¸
            if (!confirm("ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤. ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            // ì„œë²„ì— ì‚­ì œ ìš”ì²­
            fetch('/delete_account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    // ì„±ê³µ ì‹œ í™ˆí˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
                    window.location.href = "/";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('íšŒì› íƒˆí‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });
    }
    // 'ì „ì²´ ì„ íƒ' ì²´í¬ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    // 'ì„ íƒ ê¸°ë¡ ì‚­ì œ' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const selectedIds = [];
            rowCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedIds.push(checkbox.dataset.requestId);
                }
            });

            if (selectedIds.length === 0) {
                alert('ì‚­ì œí•  ê¸°ë¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (confirm(`ì„ íƒí•œ ${selectedIds.length}ê°œì˜ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // ì„œë²„ì— ì‚­ì œ ìš”ì²­ ë³´ë‚´ê¸°
                fetch('/delete_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_ids: selectedIds })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        location.reload(); // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            }
        });
    }
  });
</script>
{% endblock %}