{% extends "base.html" %}

{% block title %}ì¥ì• ë¬¼ íƒì§€{% endblock %}

{% block head_extra %}
  <style>
    /* ë§µ ìŠ¤íƒ€ì¼ */
    #map {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
    }
        /* ì‚¬ì´ë“œ ë°” ìŠ¤íƒ€ì¼*/
    .sidebar {
      position: fixed;
      top: 100px;
      left: 40px;
      width: 320px;
      height: calc(100vh - 180px);
      background: #fff;
      border-radius: 12px;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
      padding: 1.2rem 1.5rem;
      overflow-y: auto;
      z-index: 1001;
      transform: translateX(0);
      transition: transform 0.3s ease;
    }

    .sidebar.closed {
      transform: translateX(-100%);
    }

    .sidebar-toggle {
      position: fixed;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      width: 30px;
      height: 80px;
      background: white;
      border: 1px solid #ccc;
      border-right: none;
      border-radius: 0 8px 8px 0;
      z-index: 2000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* â”€â”€ ì¶œë°œì§€, ë„ì°©ì§€, ìŠ¤ì™‘ë²„íŠ¼ â”€â”€ */
    .naver-input-box {
      position: relative;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      width: 100%;
      max-width: 320px;
      background: white;
      font-size: 14px;
      box-sizing: border-box;
    }

    .naver-input-box input {
      width: 100%;
      border: none;
      padding: 12px 40px 12px 12px;
      font-size: 14px;
      background: transparent;
      outline: none;
      display: block;
    }

    .naver-input-box input:first-child {
      border-bottom: 1px solid #eee;
    }

    .naver-input-box .swap-btn {
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border: 1px solid #ccc;
      border-radius: 50%;
      background: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      z-index: 10;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë„¤ì´ë²„ ìŠ¤íƒ€ì¼ */
    .naver-input-box .swap-btn:hover {
      background-color: #e8f3ff; /* ì—°í•œ íŒŒë€ìƒ‰ */
      border-color: #1a73e8;     /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
    }

    /* ì§€ë„ ìŠ¤íƒ€ì¼  */
    .map-style-switcher {
      position: absolute;
      top: 100px;
      right: 20px;
      z-index: 3000;
      pointer-events: auto;
      background: transparent;  /* ë°°ê²½ ì™„ì „ íˆ¬ëª… */
      border-radius: 12px;
      padding: 4px;
      display: flex;
      flex-direction: row;  /* ê°€ë¡œ ì •ë ¬ */
      gap: 6px;
    }

    .style-btn {
      cursor: pointer;
      text-align: center;
      padding: 6px;
      border-radius: 8px;
      background-color: white;  /* ê° ë²„íŠ¼ì€ í°ìƒ‰ ì¹´ë“œì²˜ëŸ¼ */
      border: 1px solid #ccc;   /* ê¸°ë³¸ íšŒìƒ‰ í…Œë‘ë¦¬ */
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 60px;  /* ì¹´ë“œ í¬ê¸° ê³ ì •  */
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      color: black;  /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ */
    }

    .style-btn img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 4px;
    }

    .style-btn.active {
      border: 2px solid #1a73e8;  /* íŒŒë€ í…Œë‘ë¦¬ */
      color: #1a73e8;             /* í…ìŠ¤íŠ¸ë„ íŒŒë€ìƒ‰ìœ¼ë¡œ */
    }

    /* ===== ì£¼ì†Œ ìë™ì™„ì„±(íŒì—…) ===== */
    .autocomplete-list{
      position: absolute;
      z-index: 1200;            /* ì‚¬ì´ë“œë°”/í† ê¸€ ìœ„ë¡œ */
      background: #fff;
      border: none;
      list-style: none;
      padding: 0;
      margin: 2px 0 0;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }
    .autocomplete-list li{
      padding: 6px 10px;
      font-size: .85rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .autocomplete-list li:hover{ background-color: #f0f0f0; }

    /* ===== ë²„íŠ¼(ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë³´ì¡´) ===== */
    .btn-primary{
      display: block;
      width: 100%;
      margin-top: 1rem;
      padding: .75rem;
      font-size: 1rem;
      color: #fff;
      background-color: #3578e5;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background .2s ease;
    }
    .btn-primary:hover{ background-color: #2e66c9; }

    .btn-secondary{
      display: block;
      width: 100%;
      margin-top: .5rem;
      padding: .75rem;
      font-size: 1rem;
      color: #333;
      background-color: #e5e7eb;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background .2s ease;
    }
    .btn-secondary:hover{ background-color: #d1d5db; }

    /* ===== ê¸°ì¡´ routeBtn ì¸í„°ë™ì…˜ ìœ ì§€ ===== */
    #routeBtn{ transition: transform .1s ease; }
    #routeBtn:active{ transform: translateY(2px) scale(.98); }

    /* ===== ìë™ì™„ì„± ê¸°ì¤€ì  ===== */
    #start, #end{ position: relative; }
  </style>
{% endblock %}

{% block content %}
<div id="map"></div>

  <div class="map-style-container">
    <div class="map-style-switcher">
      <div class="style-btn" data-style="osm">
        <img src="{{ url_for('static', filename='img/ì¼ë°˜.png') }}" alt="ì¼ë°˜">
        <div>ì¼ë°˜ì§€ë„</div>
      </div>
      <div class="style-btn" data-style="satellite">
        <img src="{{ url_for('static', filename='img/ìœ„ì„±.png') }}" alt="ìœ„ì„±">
        <div>ìœ„ì„±ì§€ë„</div>
      </div>
      <div class="style-btn" data-style="topo">
        <img src="{{ url_for('static', filename='img/ì§€í˜•.png') }}" alt="ì§€í˜•">
        <div>ì§€í˜•ì§€ë„</div>
      </div>
    </div>
  </div>

  <!-- í† ê¸€ ë²„íŠ¼ -->
  <button id="toggleSidebar" class="sidebar-toggle" aria-label="Toggle sidebar">â—€</button>

  <div class="route-container">
      <aside id="sidebar" class="sidebar">
      <!-- ì‚¬ì´ë“œë°” -->
        <!-- ì¶œë°œì§€Â·ë„ì°©ì§€ ë°•ìŠ¤ -->
        <div class="naver-input-box">
          <input type="text" id="start" placeholder="ì¶œë°œì§€ ì…ë ¥" autocomplete="off" />
          <input type="text" id="end" placeholder="ë„ì°©ì§€ ì…ë ¥" autocomplete="off" />
          <div class="swap-btn" onclick="swapInputs()">â‡…</div>
        </div>
          <br /><br />
        <button id="routeBtn" class="btn-primary">ê²½ë¡œ ì°¾ê¸°</button>
        <button id="resetBtn" class="btn-secondary">ì´ˆê¸°í™”</button>
      </aside>
  </div>
</div>
  <!-- ë§µ -->

<div id="info" style="margin-top:1rem; font-weight:bold;"></div>
<div id="coordsInfo" style="margin-top:0.5rem; font-weight:bold; color: #555;"></div>

<div id="resultBox" style="margin-top: 1rem; font-weight: bold; color: #444;"></div>
<div id="utmInfo" style="margin-top: 0.5rem; font-weight: bold; color: #555;"></div>

<!-- ì™¸ë¶€ ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<!-- ì§€ë„ íƒ€ì¼, ë§ˆì»¤, ì»¨íŠ¸ë¡¤(ì¤Œ ë²„íŠ¼ ë“±) CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- ê²½ë¡œì„ , ê²½ë¡œ ì •ë³´ íŒ¨ë„ CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<!-- ë§ˆì»¤ ì°ê¸°, ì§€ë„ ì´ë™, ë ˆì´ì–´ ì¶”ê°€ -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- ê²½ë¡œë¥¼ ìë™ìœ¼ë¡œ ê³„ì‚°, ê²½ë¡œ íƒìƒ‰, ê²½ë¡œ í¸ì§‘, ì—¬ëŸ¬ ê²½ìœ ì§€ ì„¤ì • -->
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<!-- ì¢Œí‘œê³„ ë³€í™˜ ê¸°ëŠ¥ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
</style>

<script>
  let scrolledToMap = false;
  // ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜
  async function geocode(address) {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
    const data = await res.json();
    if (data.length === 0) return null;
    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
  }

  // êµ°ì‚¬ì¢Œí‘œ
  function toUTMK(lat, lon) {
    const wgs84 = "+proj=longlat +datum=WGS84 +no_defs";
    const utmk = "+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 +x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m +no_defs";
    return proj4(wgs84, utmk, [lon, lat]);
}

  // ì§€ë„ ì´ˆê¸° ìœ„ì¹˜
  const map = L.map('map', {
    zoomControl: false,
    maxBounds: [[37.4133, 126.7341], [37.7151, 127.2693]], 
    maxBoundsViscosity: 1.0,
    minZoom: 11,
    maxZoom: 18
  }).setView([37.5665, 126.9780], 14); // ì„œìš¸

  // ì§€ë„ ìŠ¤íƒ€ì¼
  const baseLayers = {
    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OSM contributors'
    }),
    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles Â© Esri'
    }),
    topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: 'Â© OSM & OpenTopoMap'
    })
  };
  L.control.attribution({ position: 'topright' }).addTo(map);
  let currentLayer = baseLayers.osm.addTo(map);

  (function() {
    function setSelectedUI(name) {
      const container = document.querySelector('.map-style-switcher');
      if (container) {
        container.querySelectorAll('.style-btn').forEach(btn => {
          btn.classList.remove('active');
          btn.classList.toggle('active', btn.dataset.style === name);
        });
      }
      const sel = document.getElementById('basemapSelect');
      if (sel && sel.value !== name) sel.value = name;
    }

    function setBase(name) {
      if (!name || !baseLayers[name]) return;
      if (currentLayer && map.hasLayer(currentLayer)) map.removeLayer(currentLayer);
      currentLayer = baseLayers[name].addTo(map);
      setSelectedUI(name);
      window.currentBase = name;
    }

    // ì•„ì´ì½˜ ë²„íŠ¼
    const switcher = document.querySelector('.map-style-switcher');
    if (switcher) {
      switcher.addEventListener('click', function(e) {
        const btn = e.target.closest('.style-btn');
        if (!btn) return;
        setBase(btn.dataset.style);
      });
    }

    // ë“œë¡­ë‹¤ìš´(ì„ íƒ)
    const sel = document.getElementById('basemapSelect');
    if (sel) sel.addEventListener('change', function(){ setBase(this.value); });

    // ì´ˆê¸° ë™ê¸°í™”
    (function initSync(){
      // currentLayerê°€ ì–´ë–¤ ê²ƒì¸ì§€ ì¶”ì •í•´ì„œ selected í‘œì‹œ
      // ê¸°ë³¸ê°’: OSM
      const preferred = window.currentBase || 'osm';
      setSelectedUI(preferred);
    })();

    // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥
    window.setBasemap = setBase;
  })();

  // ì—£ì§€ ê°€ì ¸ì˜¤ê¸°
  fetch('{{ url_for("static", filename="converted_edges.geojson") }}')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, {
      style: {
        color: 'gray',
        weight: 2,
        opacity: 0
      }
    }).addTo(map);
  });

  // ë…¸ë“œ ê°€ì ¸ì˜¤ê¸°
  fetch('{{ url_for("static", filename="converted_nodes.geojson") }}')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (feature, latlng) => {
          return L.circleMarker(latlng, {
            radius: 3,
            fillColor: "gray",
            color: "#e0e0e0",
            weight: 0.7,
            opacity: 0,
            fillOpacity: 0
          });
        }
      }).addTo(map);
    });

  // ì§€ë„ ìŠ¤íƒ€ì¼ ë³€ê²½ ì´ë²¤íŠ¸
  const sel = document.getElementById("basemapSelect");
  if (sel) {
    sel.addEventListener("change", function () {

      const selected = this.value;
      if (currentLayer) map.removeLayer(currentLayer);
      currentLayer = baseLayers[selected];
      currentLayer.addTo(map);
    
    });
  }

  let control = null;
  let startMarker = null;
  let endMarker = null;

  // ìœ„í—˜ì§€ì—­ ì˜ˆì‹œ 
  const dangerZone = L.circle([38.206, 127.301], {
    color: "red",
    fillColor: "#f03",
    fillOpacity: 0.3,
    radius: 150,
  }).addTo(map).bindPopup("ìœ„í—˜ ì§€ì—­");

  // ì¥ì• ë¬¼ ì¢Œí‘œ ì €ì¥ ë° ë§ˆì»¤ ì €ì¥
  let obstacles = [];
  let fireMarkers = [];
  let fireCircles = [];

  // ê²½ë¡œ ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨ ë³€ìˆ˜
  let marker = null;
  let routeLine = null;
  let movingMarker = null;
  let routeCoords = [];
  let currentStep = 0;
  let stopAnimation = false;

  let dangerMarkers = [];
  let pathPolyline = null; 
  
  // ì§€ë„ í´ë¦­ ì‹œ ì¥ì• ë¬¼ ì¶”ê°€ ë° ê²½ë¡œ ì¬íƒìƒ‰
  map.on('click', async (e) => {
    const { lat, lng } = e.latlng;

    fireCircles.forEach(c => map.removeLayer(c));
    fireCircles = [];

    // ì¥ì• ë¬¼ ë°°ì—´ì— ì¶”ê°€
    obstacles = [{ lat, lon: lng }];

    // ì¥ì• ë¬¼ í´ë¦­ ì‹œ
    const circle = L.circle([lat, lng], {
      radius: 100,
      color: 'red',
      fillColor: 'red',
      fillOpacity: 0.2
    }).addTo(map);
    fireCircles.push(circle);

    // ê¸°ì¡´ ì´ëª¨ì§€ ì œê±°
    fireMarkers.forEach(m => map.removeLayer(m));
    fireMarkers = [];
    
    // ì´ëª¨ì§€ ë§ˆì»¤ ì¶”ê°€
    const emoji = 'ğŸ”¥'; 
    const emojiMarker = L.marker([lat, lng], {
      icon: L.divIcon({
        className: 'emoji-icon',
        html: emoji,
        iconSize: [24, 24]
      })
    }).addTo(map);
    fireMarkers.push(emojiMarker);

  // ì´ë™ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨
  stopAnimation = true;

  // ì¶œë°œì§€, ë„ì°©ì§€ê°€ ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ ê²½ë¡œ ì¬íƒìƒ‰
  if (startMarker && endMarker && movingMarker) {
    // í˜„ì¬ ë§ˆì»¤ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ì‚¬ìš©
    const current = movingMarker.getLatLng();
    const goal = endMarker.getLatLng();

    await runDStarLitePath(
      [current.lat, current.lng], // í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ
      [goal.lat, goal.lng],
      obstacles
    );
  }
});

  // í•œ ì¹¸ì”© ì´ë™í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
  function moveStepByStep() {
    if (stopAnimation || currentStep >= routeCoords.length) {
      return;
    }
    const latlng = routeCoords[currentStep];
    movingMarker.setLatLng(latlng);
    currentStep++;

    setTimeout(() => {
      if (!stopAnimation) {
        moveStepByStep();
      }
    }, 700);
  }

  // ê²½ë¡œ ê·¸ë¦¬ê¸°
  function drawPath(path) {
    const latlngs = path.map(p => [p[1], p[0]]);
    if (window.routeLine) {
      map.removeLayer(window.routeLine);
    }
    window.routeLine = L.polyline(latlngs, { color: 'blue' }).addTo(map);
  }

  // ë§ˆì»¤ ì• ë‹ˆë©”ì´ì…˜
  function startMarkerAnimation() {
    if (!routeCoords.length) return;

    if (marker) map.removeLayer(marker);

    marker = L.marker(routeCoords[0]).addTo(map);
    currentStep = 0;

    function animate() {
      if (stopAnimation || currentStep >= routeCoords.length) return;

      marker.setLatLng(routeCoords[currentStep]);
      currentStep++;
      setTimeout(animate, 400); // ì†ë„ ì¡°ì ˆ
    }

    animate();
  }

  function stopMarkerAnimation() {
    stopAnimation = true;
  }

  // D* Lite ì•Œê³ ë¦¬ì¦˜ ê²½ë¡œ ìš”ì²­ ë° ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ í•¨ìˆ˜
  async function runDStarLitePath(start, end, obstacles=[]) {
    // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨
    stopAnimation = true;

    // ì´ˆê¸°í™” (ìƒˆ ê²½ë¡œ ì‹œì‘ ìœ„ì¹˜)
    currentStep = 0;

    // ì„œë²„ì— ê²½ë¡œ ìš”ì²­
    const res = await fetch('/run_dlite', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        start: start,
        goal: end,
        obstacles: obstacles
      })
    });

    const data = await res.json();

    if (data.error) {
      alert('ê²½ë¡œ íƒìƒ‰ ì‹¤íŒ¨: ' + data.error);
      return;
    }

    routeCoords = data.path.map(coord => [coord[1], coord[0]]); // [lon, lat] -> [lat, lon]

    // ê¸°ì¡´ ê²½ë¡œ ë° ë§ˆì»¤ ì œê±°
    if (routeLine) map.removeLayer(routeLine);
    if (movingMarker) map.removeLayer(movingMarker);

    routeLine = L.polyline(routeCoords, {color: 'red'}).addTo(map);

    movingMarker = L.marker(routeCoords[0], {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map);

    // ì§€ë„ ë·° ì¡°ì •
    map.fitBounds(L.latLngBounds([start, end]));

    // ê±°ë¦¬ ë° ê²½ë¡œ ê¸¸ì´ í‘œì‹œ
    document.getElementById('resultBox').innerHTML = `
      ğŸ”¹ ê±°ë¦¬: ${data.distance} m<br>
      ğŸ”¹ ê²½ë¡œ ë…¸ë“œ ìˆ˜: ${data.steps}
   `;

   // ì• ë‹ˆë©”ì´ì…˜ ì¬ê°œ
    stopAnimation = false;
    moveStepByStep();
  }

  // ì¹´ì¹´ì˜¤ ì£¼ì†Œ->ì¢Œí‘œ ë³€í™˜ API
  async function geocodekakao(address) {
    if (geocodeInProgress) return null;
    geocodeInProgress = true;
    try {
      const res = await fetch('/api/geocode?q=' + encodeURIComponent(address));
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const data = await res.json();
      if (data.documents && data.documents.length > 0) {
        return [parseFloat(data.documents[0].y), parseFloat(data.documents[0].x)];
      }
    } catch (e) {
      console.error("geocode ì—ëŸ¬:", e);
    } finally {
      geocodeInProgress = false;
    }
    return null;
  }

  // ì£¼ì†Œ ì…ë ¥ê°’ìœ¼ë¡œ ì¢Œí‘œ ì–»ê¸°
  async function getCoordinatesFromInput(inputId) {
    const input = document.getElementById(inputId);
    const address = input.value.trim();

    if (!address) {
      alert("ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return null;
    }

    // ì§ì ‘ Nominatim API í˜¸ì¶œ (í´ë¼ì´ì–¸íŠ¸)
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      alert(`"${address}" ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      return null;
    }

    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
  }

  // ê²½ë¡œ ìš”ì²­ í•¨ìˆ˜
  async function fetchRouteAndDrawPath(startLat, startLon, goalLat, goalLon) {
    try {
      const res = await fetch(`/route_geojson?start_lat=${startLat}&start_lon=${startLon}&goal_lat=${goalLat}&goal_lon=${goalLon}`);
      if (!res.ok) {
        throw new Error("ê²½ë¡œ ìš”ì²­ ì‹¤íŒ¨");
      }

      const data = await res.json();

      // ì§€ë„ì— ê¸°ì¡´ ê²½ë¡œê°€ ìˆë‹¤ë©´ ì œê±°
      if (window.routeLine) {
        map.removeLayer(window.routeLine);
      }

      // GeoJSON ë°ì´í„°ë¡œë¶€í„° ê²½ë¡œ ë¼ì¸ ìƒì„±
      window.routeLine = L.geoJSON(data, {
        style: {
          color: "blue",
          weight: 4
        }
      }).addTo(map);

      // ê²½ë¡œ ê±°ë¦¬ì™€ ìŠ¤í… í™•ì¸
      const dist = data.features[0].properties.distance;
      const steps = data.features[0].properties.steps;
      console.log("ì´ ê±°ë¦¬:", dist);
      console.log("ì´ ìŠ¤í…:", steps);
    } catch (err) {
      console.error("ê²½ë¡œ íƒìƒ‰ ì˜¤ë¥˜:", err);
    }
  }

  // ê²½ë¡œ ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  document.getElementById('routeBtn').addEventListener('click', async () => {
    // dataset ì´ˆê¸°í™”
    document.getElementById("start").dataset.lat = "";
    document.getElementById("start").dataset.lon = "";
    document.getElementById("end").dataset.lat = "";
    document.getElementById("end").dataset.lon = "";

    const start = await getCoordinatesFromInput("start");
    const end = await getCoordinatesFromInput("end");

    if (!start || !end) {
      alert("ì£¼ì†Œë¥¼ ì •í™•íˆ ì…ë ¥í•˜ê±°ë‚˜ ìœ íš¨í•œ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.");
      return;
    }

    // ìœ„ë„, ê²½ë„
    document.getElementById('coordsInfo').innerHTML =
      `ì¶œë°œì§€ ì¢Œí‘œ: [${start[0].toFixed(6)}, ${start[1].toFixed(6)}] <br>
       ë„ì°©ì§€ ì¢Œí‘œ: [${end[0].toFixed(6)}, ${end[1].toFixed(6)}]`;
 
    const startUTM = toUTMK(start[0], start[1]);
    const endUTM = toUTMK(end[0], end[1]);

    // êµ°ì‚¬ì¢Œí‘œ
    document.getElementById('utmInfo').innerHTML = 
       `ì¶œë°œì§€ UTM-K: [${startUTM[0].toFixed(2)}, ${startUTM[1].toFixed(2)}] <br>
        ë„ì°©ì§€ UTM-K: [${endUTM[0].toFixed(2)}, ${endUTM[1].toFixed(2)}]`;

    // ì¶œë°œ ë§ˆì»¤ (íŒŒë€ìƒ‰)
    if (startMarker) map.removeLayer(startMarker);
      startMarker = L.marker(start, {
      icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
      })
    }).addTo(map).bindPopup("ì¶œë°œ").openPopup();

    // ë„ì°© ë§ˆì»¤ (ë¹¨ê°„ìƒ‰)
    if (endMarker) map.removeLayer(endMarker);
    endMarker = L.marker(end, {
    icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
        })
    }).addTo(map).bindPopup("ë„ì°©").openPopup();

    // D* Lite ê²½ë¡œ íƒìƒ‰ ë° ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    await runDStarLitePath(start, end, obstacles);
  });

  // ì—”í„°í‚¤ ëˆŒë €ì„ ë•Œë„ ê²½ë¡œ ì°¾ê¸° ì‹¤í–‰
  ["start", "end"].forEach(id => {
    document.getElementById(id).addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("routeBtn").click();
      }
    });
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    document.getElementById('start').value = '';
    document.getElementById('end').value = '';
    document.getElementById('info').innerHTML = '';
    document.getElementById('coordsInfo').innerHTML = '';
    document.getElementById('resultBox').innerHTML = '';
   
  if (control) {
    map.removeControl(control);
    control = null;
  }
  if (startMarker) {
    map.removeLayer(startMarker);
    startMarker = null;
  }
  if (endMarker) {
    map.removeLayer(endMarker);
    endMarker = null;
  }
  if (routeLine) {
    map.removeLayer(routeLine);
    routeLine = null;
  }
  if (movingMarker) {
    map.removeLayer(movingMarker);
    movingMarker = null;
  }

  // ì¥ì• ë¬¼ ë§ˆì»¤ ì œê±°
  fireMarkers.forEach(marker => map.removeLayer(marker));
  fireMarkers = [];

  // ì¥ì• ë¬¼ ë°˜ê²½ ì œê±°
  fireCircles.forEach(c => map.removeLayer(c));
  fireCircles = [];

  // ì¥ì• ë¬¼ ë°°ì—´ ì´ˆê¸°í™”
  obstacles = [];

  // ê²½ë¡œ ë³€ìˆ˜ ì´ˆê¸°í™”
  routeCoords = [];
  currentStep = 0;

  // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
  stopAnimation = true;
  });
</script>

<style>
  .moving-icon {
    font-size: 24px;
  }
  .emoji-icon {
    font-size: 24px;
    line-height: 24px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    if (!btn || !sidebar) return;
    btn.addEventListener("click", () => {
      const closed = sidebar.classList.toggle("closed");
      btn.textContent = closed ? "â–¶" : "â—€";
    });
  });
</script>

<!-- ë²„íŠ¼ ìŠ¤ì™‘ ê¸°ëŠ¥ -->
<script>
function swapInputs() {
  const start = document.getElementById("start");
  const end = document.getElementById("end");
  const temp = start.value;
  start.value = end.value;
  end.value = temp;
}
</script>

<!-- .style-btn icons or #basemapSelect dropdown -->
<script>
(function() {
  if (typeof L === 'undefined' || typeof map === 'undefined') return;

  window.baseLayers = window.baseLayers || {
    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }),
    satellite: L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Tiles &copy; Esri'
    }),
    light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: '&copy; CARTO'
    }),
    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: '&copy; CARTO'
    })
  };

  let currentName = window.currentName || null;
  window.currentLayer = window.currentLayer || null;

  if (!window.currentLayer || !map.hasLayer(window.currentLayer)) {
    setBase(currentName || 'osm');
  } else {
    setSelectedUI(currentName || 'osm');
  }

  const switcher = document.querySelector('.map-style-switcher');
  if (switcher) {
    switcher.addEventListener('click', function(e) {
      const btn = e.target.closest('.style-btn');
      if (!btn) return;
      const name = btn.dataset.style;
      setBase(name);
    });
  }

  const sel = document.getElementById('basemapSelect');
  if (sel) {
    sel.addEventListener('change', function() {
      setBase(this.value);
    });
  }

  window.setBasemap = setBase;
})();
</script>

{% endblock %}